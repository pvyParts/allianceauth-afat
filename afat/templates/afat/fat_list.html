{% extends 'allianceauth/base.html' %}

{% load i18n %}
{% load static %}

{% block page_title %}{% trans 'Fleet Activity' %}{% endblock %}

{% block content %}
    <div class="col-lg-12">
        <br>
        {% include "afat/partials/menu.html" %}

        <h2>{% trans "All FAT Links" %}</h2>

        <h4>
            <a class="btn btn-primary btn-sm" href="{% url 'afat:links' year_prev %}" title='{% trans "Previous Month" %}'><i class="fas fa-backward"></i></a>

            <span class="afat-label-statistics">{{ year }}</span>

            {% if year_next <= year_current %}
                <a class="btn btn-primary btn-sm" href="{% url 'afat:links' year_next %}" title='{% trans "Next Month" %}'><i class="fas fa-forward"></i></a>
                <a class="btn btn-primary btn-sm" href="{% url 'afat:links' year_current %}" title='{% trans "Current Month" %}'><i class="fas fa-fast-forward"></i></a>
            {% endif %}
        </h4>

        {% if msg %}
            <div class="alert alert-{{ msg.0 }} alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="close">
                    <span aria-hidden="true">&times</span>
                </button>

                <h4>
                    {% if msg.0 == 'danger' %}
                        {% trans "Oh No!" %}
                    {% elif msg.0 == 'success' %}
                        {% trans "Success!" %}
                    {% endif %}
                </h4>

                <p>{{ msg.1 }}</p>
            </div>
        {% endif %}

        <table class="table" id="link-list">
            <thead>
                <th>{% trans "Fleet Name" %}</th>
                <th>{% trans "Fleet Type" %}</th>
                <th>{% trans "Creator" %}</th>
                <th>{% trans "EVE Time" %}</th>
                <th>{% trans "# of FATs" %}</th>

                {% if permissions.fatlinks.manipulate %}
                    <th>{% trans "Actions" %}</th>
                {% endif %}
            </thead>

            <tbody></tbody>
        </table>
    </div>

    {% include "afat/modals/delete-fat-link.html" %}
{% endblock %}

{% block extra_javascript %}
    {% include 'bundles/datatables-js.html' %}
    {% include 'bundles/moment-js.html' with locale=True %}

    <script type="application/javascript" src="{% static 'afat/libs/datatables/plugins/dataTables.rowGroup.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'afat/libs/datatables/plugins/datetime.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/filterDropDown/filterDropDown.min.js' %}"></script>
{% endblock %}

{% block extra_css %}
    {% include 'bundles/datatables-css.html' %}

    <link rel="stylesheet" type="text/css" href="{% static 'afat/css/allianceauth-afat.min.css' %}">
{% endblock %}

{% block extra_script %}
    $(document).ready(function() {
        const DATETIME_FORMAT = 'YYYY-MMM-DD, HH:mm';

        {% if permissions.fatlinks.manipulate %}
            var esi_column = 6;
        {% else %}
            var esi_column = 5;
        {% endif %}

        $('#link-list').DataTable({
            ajax: {
                url: "{% url 'afat:links_data' year %}",
                dataSrc: '',
                cache: false
            },
            columns: [
                {data: 'fatlink_fleet'},
                {data: 'link_type'},
                {data: 'creator'},
                {
                    data: 'time',
                    render: $.fn.dataTable.render.moment( moment.ISO_8601, DATETIME_FORMAT )
                },
                {data: 'fats_number'},

                {% if permissions.fatlinks.manipulate %}
                    {data: 'actions'},
                {% endif %}

                // hidden column
                {data: 'via_esi'},
            ],

            columnDefs: [
                {
                    orderable: false,
                    targets: [5]
                },
                {
                    visible: false,
                    targets: [esi_column]
                }
            ],

            order: [
                [3, "desc"]
            ],

            filterDropDown: {
                columns: [
                    {
                        idx: 1,
                    },
//                    {
//                        idx: 2,
//                    },
                    {
                        idx: esi_column,
                        title: "{% trans 'via ESI' %}"
                    },
                ],
                autoSize: false,
                bootstrap: true
            },
        });
    });

    $('#deleteModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        var url = button.data('url') // Extract info from data-* attributes
        var name = button.data('name');

        var modal = $(this)
        modal.find('#fat-link').attr("href", url)
        modal.find('.modal-body').text('{% trans "Are you sure you want to delete" %} ' + name + '?');
    });
{% endblock %}
